<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenDemocracy — Your Voice, Verified</title>
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #242836;
    --border: #2e3345;
    --text: #e4e6f0;
    --text2: #9196ab;
    --accent: #6c8cff;
    --accent2: #4a6adf;
    --green: #4caf87;
    --green2: #3a9070;
    --red: #e05555;
    --orange: #e0993a;
    --radius: 12px;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    min-height: 100vh;
  }

  /* ---- Header ---- */
  header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 0.8rem 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky; top: 0; z-index: 100;
  }
  .logo { font-size: 1.2rem; font-weight: 700; letter-spacing: -0.02em; }
  .logo span { color: var(--accent); }
  .header-stats { display: flex; gap: 1.5rem; font-size: 0.8rem; color: var(--text2); }
  .header-stats strong { color: var(--accent); font-weight: 600; }

  /* ---- Layout ---- */
  .container { max-width: 880px; margin: 0 auto; padding: 0 1.5rem; }
  section { margin-bottom: 2.5rem; }

  /* ---- Hero ---- */
  .hero {
    text-align: center;
    padding: 3.5rem 1rem 2.5rem;
  }
  .hero h2 {
    font-size: 2rem;
    font-weight: 700;
    letter-spacing: -0.03em;
    margin-bottom: 0.75rem;
    line-height: 1.2;
  }
  .hero h2 em {
    font-style: normal;
    color: var(--accent);
  }
  .hero p {
    color: var(--text2);
    font-size: 1.05rem;
    max-width: 560px;
    margin: 0 auto 1.5rem;
  }

  /* ---- How-it-works steps ---- */
  .steps {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 0.5rem;
  }
  .step {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1.25rem;
    text-align: center;
  }
  .step .num {
    display: inline-block;
    width: 2rem; height: 2rem; line-height: 2rem;
    background: var(--accent);
    color: #fff;
    border-radius: 50%;
    font-size: 0.85rem;
    font-weight: 700;
    margin-bottom: 0.6rem;
  }
  .step h3 { font-size: 0.95rem; margin-bottom: 0.3rem; }
  .step p { font-size: 0.8rem; color: var(--text2); margin: 0; }

  /* ---- Cards ---- */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1.5rem;
    margin-bottom: 1rem;
  }
  .card h2 { font-size: 1.1rem; margin-bottom: 0.4rem; }
  .card p.desc { color: var(--text2); font-size: 0.9rem; margin-bottom: 1rem; }

  /* ---- Buttons ---- */
  button {
    background: var(--accent); color: #fff; border: none;
    border-radius: 8px; padding: 0.6rem 1.4rem;
    font-size: 0.9rem; font-weight: 500; cursor: pointer;
    transition: background 0.15s;
  }
  button:hover { background: var(--accent2); }
  button:disabled { opacity: 0.35; cursor: not-allowed; }
  button.green { background: var(--green); }
  button.green:hover { background: var(--green2); }
  button.secondary {
    background: var(--surface2); border: 1px solid var(--border); color: var(--text);
  }
  button.secondary:hover { background: var(--border); }
  button.full { width: 100%; }

  /* ---- Identity banner ---- */
  .id-banner {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1.25rem 1.5rem;
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 1.5rem; gap: 1rem;
    flex-wrap: wrap;
  }
  .id-banner .meta { font-size: 0.85rem; color: var(--text2); }
  .id-banner .status { font-weight: 600; font-size: 0.95rem; }
  .enrolled { color: var(--green); }
  .not-enrolled { color: var(--orange); }

  /* ---- Biometric factors ---- */
  .factors {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.75rem;
    margin-bottom: 1.25rem;
  }
  @media (max-width: 500px) { .factors { grid-template-columns: repeat(2, 1fr); } }
  .factor {
    background: var(--surface2);
    border: 2px solid var(--border);
    border-radius: 10px;
    padding: 1rem 0.5rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.15s;
    user-select: none;
  }
  .factor:hover { border-color: var(--accent); color: var(--text); }
  .factor.on {
    border-color: var(--green);
    background: rgba(76, 175, 135, 0.08);
    color: var(--text);
  }
  .factor .ic { font-size: 2rem; margin-bottom: 0.2rem; }
  .factor .nm { font-size: 0.8rem; font-weight: 500; color: var(--text2); }
  .factor.on .nm { color: var(--green); }
  .factor .check { display: none; font-size: 0.7rem; color: var(--green); }
  .factor.on .check { display: block; }

  /* ---- Progress bar ---- */
  .prog { height: 4px; background: var(--border); border-radius: 2px; margin-bottom: 1rem; overflow: hidden; }
  .prog .bar { height: 100%; background: var(--green); border-radius: 2px; transition: width 0.4s ease; }

  /* ---- Forms ---- */
  textarea, select, input[type="text"] {
    width: 100%; background: var(--surface2);
    border: 1px solid var(--border); border-radius: 8px;
    padding: 0.7rem 1rem; color: var(--text);
    font-size: 0.9rem; font-family: inherit; resize: vertical;
  }
  textarea:focus, select:focus, input:focus { outline: none; border-color: var(--accent); }
  label { display: block; font-size: 0.8rem; font-weight: 500; color: var(--text2); margin-bottom: 0.35rem; }
  .field { margin-bottom: 1rem; }

  /* ---- Tabs ---- */
  .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.25rem; }
  .tab {
    padding: 0.45rem 1rem; background: var(--surface2);
    border: 1px solid var(--border); border-radius: 8px;
    font-size: 0.8rem; cursor: pointer; color: var(--text2);
    transition: all 0.15s;
  }
  .tab:hover { color: var(--text); }
  .tab.on { background: var(--accent); border-color: var(--accent); color: #fff; }

  /* ---- Submissions ---- */
  .sub-item {
    background: var(--surface2); border-radius: 8px;
    padding: 0.7rem 1rem; margin-bottom: 0.5rem; font-size: 0.9rem;
  }
  .badge {
    display: inline-block; font-size: 0.7rem; font-weight: 600;
    padding: 0.12rem 0.45rem; border-radius: 4px; margin-right: 0.5rem;
    text-transform: uppercase; letter-spacing: 0.02em;
  }
  .badge-opinion { background: rgba(108,140,255,0.2); color: var(--accent); }
  .badge-idea { background: rgba(224,153,58,0.2); color: var(--orange); }
  .badge-vote { background: rgba(76,175,135,0.2); color: var(--green); }

  /* ---- Topic list ---- */
  .topic {
    cursor: pointer; transition: border-color 0.15s;
  }
  .topic:hover { border-color: var(--accent); }
  .topic.on { border-color: var(--accent); background: rgba(108,140,255,0.04); }
  .topic h3 { font-size: 1rem; margin-bottom: 0.25rem; }
  .topic p { margin: 0; }

  /* ---- Alert ---- */
  .alert {
    padding: 0.7rem 1rem; border-radius: 8px; font-size: 0.85rem;
    margin-bottom: 1rem; display: none;
  }
  .alert.ok { background: rgba(76,175,135,0.12); color: var(--green); display: block; }
  .alert.err { background: rgba(224,85,85,0.12); color: var(--red); display: block; }

  /* ---- Privacy note ---- */
  .privacy {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1.25rem 1.5rem;
    margin-bottom: 2rem;
    font-size: 0.85rem;
    color: var(--text2);
    line-height: 1.7;
  }
  .privacy strong { color: var(--text); }

  .hidden { display: none !important; }

  /* ---- Footer ---- */
  footer {
    text-align: center; padding: 2rem 1rem;
    color: var(--text2); font-size: 0.78rem;
    border-top: 1px solid var(--border);
  }
  footer a { color: var(--accent); text-decoration: none; }
</style>
</head>
<body>

<!-- ================================================================ -->
<!-- HEADER                                                           -->
<!-- ================================================================ -->
<header>
  <div class="logo"><span>Open</span>Democracy</div>
  <div class="header-stats">
    <span>Verified participants: <strong id="st-enrolled">0</strong></span>
    <span>Submissions: <strong id="st-subs">0</strong></span>
  </div>
</header>

<div class="container">

  <!-- ============================================================== -->
  <!-- HERO                                                           -->
  <!-- ============================================================== -->
  <div class="hero">
    <h2>Your voice. <em>Verified.</em><br>One person, one vote.</h2>
    <p>Share opinions, propose ideas, and vote on the issues that matter.
       Biometric verification makes sure every voice counts exactly once.</p>
  </div>

  <!-- ============================================================== -->
  <!-- HOW IT WORKS                                                   -->
  <!-- ============================================================== -->
  <section>
    <div class="steps">
      <div class="step">
        <div class="num">1</div>
        <h3>Verify your identity</h3>
        <p>Scan 2+ biometric factors. Data stays on your device.</p>
      </div>
      <div class="step">
        <div class="num">2</div>
        <h3>Browse topics</h3>
        <p>See what issues are open for public input.</p>
      </div>
      <div class="step">
        <div class="num">3</div>
        <h3>Participate</h3>
        <p>Submit opinions, ideas, or votes — once per topic.</p>
      </div>
    </div>
  </section>

  <!-- alert -->
  <div class="alert" id="alert"></div>

  <!-- ============================================================== -->
  <!-- ENROLLMENT / IDENTITY                                          -->
  <!-- ============================================================== -->
  <section id="sec-enroll">
    <div class="id-banner" id="id-banner">
      <div>
        <div class="meta">Identity</div>
        <div class="status not-enrolled" id="id-text">Not yet verified</div>
      </div>
      <button id="id-btn" onclick="toggleEnroll()">Verify Identity</button>
    </div>

    <div class="card hidden" id="enroll-card">
      <h2>Biometric Verification</h2>
      <p class="desc">
        Select at least 2 factors below. In a production system your phone
        or computer would scan your actual biometrics — fingerprint reader,
        face camera, iris scanner, or microphone. The raw data never leaves
        your device; only a cryptographic key is sent to the server.
      </p>

      <div class="prog"><div class="bar" id="prog-bar" style="width:0%"></div></div>

      <div class="factors" id="factors">
        <div class="factor" data-f="fingerprint" onclick="pickFactor(this)">
          <div class="ic">&#9757;</div>
          <div class="nm">Fingerprint</div>
          <div class="check">&#10003; selected</div>
        </div>
        <div class="factor" data-f="face" onclick="pickFactor(this)">
          <div class="ic">&#128100;</div>
          <div class="nm">Face</div>
          <div class="check">&#10003; selected</div>
        </div>
        <div class="factor" data-f="iris" onclick="pickFactor(this)">
          <div class="ic">&#128065;</div>
          <div class="nm">Iris Scan</div>
          <div class="check">&#10003; selected</div>
        </div>
        <div class="factor" data-f="voice" onclick="pickFactor(this)">
          <div class="ic">&#127908;</div>
          <div class="nm">Voice</div>
          <div class="check">&#10003; selected</div>
        </div>
      </div>

      <button class="green full" id="enroll-btn" onclick="doEnroll()" disabled>
        Select at least 2 factors
      </button>
    </div>
  </section>

  <!-- ============================================================== -->
  <!-- TOPICS                                                         -->
  <!-- ============================================================== -->
  <section>
    <h2 style="margin-bottom:0.75rem; font-size:1.15rem;">Open Topics</h2>
    <div id="topic-list"></div>
  </section>

  <!-- ============================================================== -->
  <!-- PARTICIPATE (shown when a topic is selected)                   -->
  <!-- ============================================================== -->
  <section id="sec-participate" class="hidden">
    <div class="card">
      <h2 id="part-title"></h2>
      <p class="desc" id="part-desc"></p>

      <div class="tabs" id="part-tabs"></div>

      <div id="form-opinion" class="hidden">
        <div class="field">
          <label for="txt-opinion">Share your perspective</label>
          <textarea id="txt-opinion" rows="4" placeholder="What do you think about this issue?"></textarea>
        </div>
        <button class="green" onclick="send('opinion')">Submit Opinion</button>
      </div>

      <div id="form-idea" class="hidden">
        <div class="field">
          <label for="txt-idea">Propose a solution or approach</label>
          <textarea id="txt-idea" rows="4" placeholder="Describe your idea..."></textarea>
        </div>
        <button class="green" onclick="send('idea')">Submit Idea</button>
      </div>

      <div id="form-vote" class="hidden">
        <div class="field">
          <label for="sel-vote">Cast your vote</label>
          <select id="sel-vote"></select>
        </div>
        <button class="green" onclick="send('vote')">Cast Vote</button>
      </div>
    </div>

    <div class="card">
      <h2>What others have said</h2>
      <div id="sub-list">
        <p style="color:var(--text2); font-size:0.85rem;">
          No submissions yet. Be the first to participate.
        </p>
      </div>
    </div>
  </section>

  <!-- ============================================================== -->
  <!-- PRIVACY EXPLAINER                                              -->
  <!-- ============================================================== -->
  <div class="privacy">
    <strong>How your data is protected:</strong>
    Your biometric scans (fingerprint, face, iris, voice) are processed
    entirely on your own device. The raw data is hashed and discarded
    immediately. Only a one-way cryptographic key is registered with the
    server — it cannot be reversed back to your biometrics. Your
    submissions are linked to an anonymous ID, not your name or personal
    information. One key per person means one vote per person — no fakes,
    no duplicates.
  </div>
</div>

<footer>
  OpenDemocracy &mdash; open-source participatory democracy
  &middot; <a href="https://github.com/AshmanRoonz/OpenDemocracy" target="_blank">GitHub</a>
</footer>

<!-- ================================================================ -->
<!-- JAVASCRIPT                                                       -->
<!-- ================================================================ -->
<script>
/* ---- state ---- */
let me = JSON.parse(localStorage.getItem("od_me") || "null");
let factors = [];
let topic = null;
let tab = "opinion";

/* ---- boot ---- */
document.addEventListener("DOMContentLoaded", () => {
  refreshIdentity();
  loadTopics();
  loadStats();
});

/* ---- identity UI ---- */
function refreshIdentity() {
  const txt = document.getElementById("id-text");
  const btn = document.getElementById("id-btn");
  if (me) {
    txt.textContent = "Verified (" + me.factors_enrolled.join(", ") + ")";
    txt.className = "status enrolled";
    btn.textContent = "Verified";
    btn.disabled = true;
    btn.className = "secondary";
    document.getElementById("enroll-card").classList.add("hidden");
  } else {
    txt.textContent = "Not yet verified";
    txt.className = "status not-enrolled";
    btn.textContent = "Verify Identity";
    btn.disabled = false;
  }
}

function toggleEnroll() {
  document.getElementById("enroll-card").classList.toggle("hidden");
}

/* ---- factor selection ---- */
function pickFactor(el) {
  const f = el.dataset.f;
  el.classList.toggle("on");
  factors = [...document.querySelectorAll(".factor.on")].map(e => e.dataset.f);
  const pct = Math.min((factors.length / 2) * 100, 100);
  document.getElementById("prog-bar").style.width = pct + "%";
  const btn = document.getElementById("enroll-btn");
  btn.disabled = factors.length < 2;
  btn.textContent = factors.length < 2
    ? "Select at least 2 factors"
    : "Verify with " + factors.join(" + ");
}

/* ---- enrollment ---- */
async function doEnroll() {
  const btn = document.getElementById("enroll-btn");
  btn.disabled = true;
  btn.textContent = "Scanning biometrics...";
  await pause(1200);
  btn.textContent = "Generating cryptographic key...";
  await pause(600);

  try {
    const r = await api("POST", "/api/enroll", { factors });
    me = {
      anonymous_id: r.anonymous_id,
      public_key: r.public_key,
      private_key: r.private_key,
      factors_enrolled: r.factors_enrolled,
    };
    localStorage.setItem("od_me", JSON.stringify(me));
    refreshIdentity();
    loadStats();
    flash("Identity verified. Your cryptographic key is stored in this browser.", "ok");
  } catch (e) {
    flash(e.message, "err");
    btn.disabled = false;
    btn.textContent = "Verify with " + factors.join(" + ");
  }
}

/* ---- topics ---- */
async function loadTopics() {
  try {
    const list = await api("GET", "/api/topics");
    const el = document.getElementById("topic-list");
    if (!list.length) {
      el.innerHTML = '<p style="color:var(--text2)">No open topics right now.</p>';
      return;
    }
    el.innerHTML = list.map(t =>
      '<div class="card topic" onclick="openTopic(\'' + t.id + '\')">' +
        '<h3>' + esc(t.title) + '</h3>' +
        '<p class="desc">' + esc(t.description) + '</p>' +
      '</div>'
    ).join("");
  } catch (_) { /* silent */ }
}

async function openTopic(id) {
  const list = await api("GET", "/api/topics");
  const t = list.find(x => x.id === id);
  if (!t) return;
  topic = t;

  document.querySelectorAll(".topic").forEach(el => {
    el.classList.toggle("on", el.querySelector("h3").textContent === t.title);
  });

  document.getElementById("sec-participate").classList.remove("hidden");
  document.getElementById("part-title").textContent = t.title;
  document.getElementById("part-desc").textContent = t.description;

  /* build tabs */
  const allowed = [];
  if (t.allow_opinions) allowed.push("opinion");
  if (t.allow_ideas)    allowed.push("idea");
  if (t.allow_votes)    allowed.push("vote");
  document.getElementById("part-tabs").innerHTML = allowed.map(x =>
    '<div class="tab" onclick="setTab(\'' + x + '\')">' +
      x.charAt(0).toUpperCase() + x.slice(1) +
    '</div>'
  ).join("");
  if (allowed.length) setTab(allowed[0]);

  if (t.vote_options.length) {
    document.getElementById("sel-vote").innerHTML =
      t.vote_options.map(o => '<option value="'+esc(o)+'">'+esc(o)+'</option>').join("");
  }

  loadSubs(id);
}

function setTab(t) {
  tab = t;
  document.querySelectorAll(".tab").forEach(el =>
    el.classList.toggle("on", el.textContent.toLowerCase() === t)
  );
  document.getElementById("form-opinion").classList.toggle("hidden", t !== "opinion");
  document.getElementById("form-idea").classList.toggle("hidden", t !== "idea");
  document.getElementById("form-vote").classList.toggle("hidden", t !== "vote");
}

/* ---- submit ---- */
async function send(type) {
  if (!me) { flash("You must verify your identity first.", "err"); return; }
  if (!topic) return;

  let content = "";
  if (type === "opinion") content = document.getElementById("txt-opinion").value.trim();
  else if (type === "idea") content = document.getElementById("txt-idea").value.trim();
  else if (type === "vote") content = document.getElementById("sel-vote").value;
  if (!content) { flash("Please enter your " + type + " first.", "err"); return; }

  try {
    /* 1 — get challenge */
    const ch = await api("POST", "/api/challenge", { anonymous_id: me.anonymous_id });

    /* 2 — sign locally (browser Web Crypto = on-device) */
    const sig = await hmac(me.public_key, ch.nonce);

    /* 3 — submit with proof */
    const res = await api("POST", "/api/submit", {
      anonymous_id: me.anonymous_id,
      challenge_id: ch.challenge_id,
      signature: sig,
      topic_id: topic.id,
      submission_type: type,
      content,
    });

    flash(res.message, "ok");
    if (type === "opinion") document.getElementById("txt-opinion").value = "";
    if (type === "idea")    document.getElementById("txt-idea").value = "";
    loadSubs(topic.id);
    loadStats();
  } catch (e) {
    flash(e.message, "err");
  }
}

async function loadSubs(topicId) {
  try {
    const subs = await api("GET", "/api/topics/" + topicId + "/submissions");
    const el = document.getElementById("sub-list");
    if (!subs.length) {
      el.innerHTML = '<p style="color:var(--text2);font-size:0.85rem;">No submissions yet. Be the first.</p>';
      return;
    }
    el.innerHTML = subs.map(s =>
      '<div class="sub-item">' +
        '<span class="badge badge-' + s.submission_type + '">' + s.submission_type + '</span>' +
        esc(s.content) +
      '</div>'
    ).join("");
  } catch (_) { /* silent */ }
}

/* ---- stats ---- */
async function loadStats() {
  try {
    const d = await api("GET", "/api/stats");
    document.getElementById("st-enrolled").textContent = d.enrolled_participants;
    document.getElementById("st-subs").textContent = d.total_submissions;
  } catch (_) { /* silent */ }
}

/* ---- helpers ---- */
async function api(method, url, body) {
  const opts = { method, headers: {} };
  if (body) {
    opts.headers["Content-Type"] = "application/json";
    opts.body = JSON.stringify(body);
  }
  const r = await fetch(url, opts);
  const d = await r.json();
  if (!r.ok) throw new Error(d.detail || "Request failed");
  return d;
}

async function hmac(key, msg) {
  const enc = new TextEncoder();
  const k = await crypto.subtle.importKey(
    "raw", enc.encode(key), { name: "HMAC", hash: "SHA-256" }, false, ["sign"]
  );
  const sig = await crypto.subtle.sign("HMAC", k, enc.encode(msg));
  return [...new Uint8Array(sig)].map(b => b.toString(16).padStart(2, "0")).join("");
}

function flash(msg, type) {
  const el = document.getElementById("alert");
  el.textContent = msg;
  el.className = "alert " + type;
  el.scrollIntoView({ behavior: "smooth", block: "nearest" });
  setTimeout(() => { el.className = "alert"; }, 6000);
}

function esc(s) {
  const d = document.createElement("div");
  d.textContent = s;
  return d.innerHTML;
}

function pause(ms) { return new Promise(r => setTimeout(r, ms)); }
</script>
</body>
</html>
